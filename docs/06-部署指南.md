# 基于云计算的课程资料分享平台 - 部署指南

## 一、部署概述

### 1.1 部署架构

```
开发环境 ──CI/CD──> 测试环境 ──审批──> 生产环境
   ↓              ↓              ↓
本地开发        自动化测试      线上环境
Docker          SAE测试集群      SAE生产集群
```

### 1.2 环境说明

| 环境 | 用途 | 域名 | 规格 |
|------|------|------|------|
| 开发环境 | 本地开发 | localhost | Docker Compose |
| 测试环境 | 功能测试 | test.example.com | SAE 1核2GB |
| 生产环境 | 线上服务 | www.example.com | SAE 2核4GB × 2 |

---

## 二、本地开发环境搭建

### 2.1 前置要求

- **开发机**: Windows 10/11, macOS, 或 Linux
- **Node.js**: 18.17+ (LTS)
- **Docker Desktop**: 最新版
- **Git**: 最新版
- **VS Code**: 推荐IDE

### 2.2 克隆项目

```bash
# 克隆仓库
git clone https://github.com/your-org/course-sharing-platform.git
cd course-sharing-platform

# 安装后端依赖
cd backend
npm install

# 安装前端依赖
cd ../frontend
npm install
```

### 2.3 配置环境变量

```bash
# backend/.env.development
NODE_ENV=development
PORT=8080
DB_HOST=localhost
DB_PORT=3306
DB_NAME=course_sharing_platform
DB_USER=root
DB_PASSWORD=root
JWT_SECRET=dev_secret_key_change_in_production
JWT_EXPIRES_IN=7d
OSS_REGION=oss-cn-hangzhou
OSS_ACCESS_KEY_ID=your_access_key
OSS_ACCESS_KEY_SECRET=your_secret_key
OSS_BUCKET_NAME=your-bucket
CORS_ORIGIN=http://localhost:5173
```

### 2.4 启动开发环境

```bash
# 启动数据库服务
cd docker
docker-compose up -d

# 初始化数据库
mysql -h 127.0.0.1 -u root -p
# 执行 scripts/init-db.sql

# 启动后端服务
cd backend
npm run dev

# 启动前端服务
cd frontend
npm run dev
```

### 2.5 访问应用

- 前端地址: http://localhost:5173
- 后端API: http://localhost:8080/api/v1
- 数据库: localhost:3306

---

## 三、阿里云资源准备

### 3.1 开通服务

登录阿里云控制台，依次开通以下服务：

1. **Serverless应用引擎 (SAE)**
   - 链接: https://sae.console.aliyun.com/
   - 选择: 应用 > 创建应用

2. **云数据库 PolarDB**
   - 链接: https://polardb.console.aliyun.com/
   - 选择: 创建实例

3. **对象存储 OSS**
   - 链接: https://oss.console.aliyun.com/
   - 选择: 创建Bucket

### 3.2 创建 RAM 用户

```yaml
步骤:
  1. 访问 RAM控制台
  2. 创建用户: course-platform-app
  3. 访问方式: 编程访问
  4. 权限: AliyunSAEFullAccess, AliyunPolarDBFullAccess, AliyunOSSFullAccess
  5. 保存 AccessKeyID 和 AccessKeySecret
```

### 3.3 购买资源

| 资源 | 配置 | 数量 | 预估成本/月 |
|------|------|------|------------|
| SAE | 2核4GB | 2实例×24h | ¥518 |
| PolarDB | 4核8GB | 1实例 | ¥5,400 |
| OSS | 500GB | - | ¥60 |
| **合计** | | | **¥5,978** |

---

## 四、生产环境部署

### 4.1 PolarDB 数据库部署

#### 4.1.1 创建实例

```bash
# 登录 PolarDB 控制台
# 选择: 创建实例
# 配置:
  - 产品系列: PolarDB for MySQL
  - 数据库版本: MySQL 8.0
  - 系列: 集群版
  - 节点规格: 4核8GB
  - 节点数量: 1主1只读
  - 存储空间: 100GB
  - 网络类型: 专有网络 (VPC)
```

#### 4.1.2 初始化数据库

```bash
# 获取数据库连接信息
# - 内网地址: rm-xxxxx.mysql.rds.aliyuncs.com
# - 端口: 3306
# - 初始账号: root
# - 初始密码: (创建时设置)

# 连接数据库
mysql -h rm-xxxxx.mysql.rds.aliyuncs.com -P 3306 -u root -p

# 执行初始化脚本
source scripts/init-db.sql
```

#### 4.1.3 配置白名单

```bash
# 在 PolarDB 控制台 > 数据安全性 > 白名单设置
# 添加 SAE 应用的 IP 段
```

### 4.2 OSS 存储部署

#### 4.2.1 创建 Bucket

```bash
# 登录 OSS 控制台
# 创建 Bucket:
  - Bucket名称: course-platform-files (全局唯一)
  - 地域: 华东1（杭州）
  - 存储类型: 标准存储
  - 读写权限: 私有
```

#### 4.2.2 配置 Bucket

```bash
# 1. 设置生命周期规则
规则1: 删除过期临时文件
  前缀: uploads/temp/
  过期时间: 7天

规则2: 冷热数据分层
  前缀: materials/
  转换时间: 90天
  转换为: 低频访问存储

# 2. 配置跨域规则 (CORS)
来源: https://yourdomain.com
允许Methods: GET, POST, PUT, DELETE, HEAD
允许Headers: *
暴露Headers: ETag
缓存时间: 3600秒

# 3. 设置防盗链
允许空Referer: 否
允许Referer白名单: https://yourdomain.com
```

#### 4.2.3 创建目录结构

```bash
# 使用 OSS 管理控制台或 ossutil 创建目录
ossutil mkdir oss://course-platform-files/avatars/
ossutil mkdir oss://course-platform-files/materials/
ossutil mkdir oss://course-platform-files/course-covers/
ossutil mkdir oss://course-platform-files/uploads/temp/
```

### 4.3 容器镜像构建

#### 4.3.1 Dockerfile

```dockerfile
# backend/Dockerfile
FROM node:18-alpine

# 设置工作目录
WORKDIR /app

# 复制 package.json
COPY package*.json ./

# 安装依赖
RUN npm ci --only=production

# 复制应用代码
COPY . .

# 暴露端口
EXPOSE 8080

# 健康检查
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD node -e "require('http').get('http://localhost:8080/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"

# 启动应用
CMD ["node", "src/app.js"]
```

#### 4.3.2 构建镜像

```bash
# 登录阿里云容器镜像服务
docker login --username=your_username registry.cn-hangzhou.aliyuncs.com

# 构建镜像
docker build -t course-platform-backend:latest .

# 打标签
docker tag course-platform-backend:latest registry.cn-hangzhou.aliyuncs.com/your-namespace/course-platform-backend:latest

# 推送镜像
docker push registry.cn-hangzhou.aliyuncs.com/your-namespace/course-platform-backend:latest
```

### 4.4 SAE 应用部署

#### 4.4.1 创建应用

```bash
# 登录 SAE 控制台
# 选择: 应用 > 创建应用 > 镜像方式
# 基本配置:
  - 应用名称: course-platform-backend
  - 应用描述: 课程资料分享平台后端
  - 部署方式: 镜像

# 应用配置:
  - 镜像地址: registry.cn-hangzhou.aliyuncs.com/your-namespace/course-platform-backend:latest
  - 容器端口: 8080
```

#### 4.4.2 配置环境变量

在 SAE 控制台添加以下环境变量：

```bash
# 数据库配置
DB_HOST=rm-xxxxx.mysql.rds.aliyuncs.com
DB_PORT=3306
DB_NAME=course_sharing_platform
DB_USER=course_user
DB_PASSWORD=your_secure_password_here

# OSS配置
OSS_REGION=oss-cn-hangzhou
OSS_ACCESS_KEY_ID=LTAI5txxxxx
OSS_ACCESS_KEY_SECRET=xxxxx
OSS_BUCKET_NAME=course-platform-files
OSS_ENDPOINT=https://oss-cn-hangzhou.aliyuncs.com

# JWT配置
JWT_SECRET=your_jwt_secret_key_change_in_production
JWT_EXPIRES_IN=7d

# 应用配置
NODE_ENV=production
PORT=8080
CORS_ORIGIN=https://yourdomain.com

# 日志配置
LOG_LEVEL=info
```

#### 4.4.3 配置弹性伸缩

```bash
# 在 SAE 控制台 > 应用设置 > 弹性伸缩
# 配置:
  - 弹性策略: 指标弹性
  - 最小实例数: 2
  - 最大实例数: 10
  - 指标类型: CPU使用率
  - 目标值: 70%
  - 扩容条件: CPU > 80% 持续3分钟
  - 缩容条件: CPU < 30% 持续5分钟
```

#### 4.4.4 启动应用

```bash
# 点击"部署应用"按钮
# 等待应用启动成功
# 获取应用访问地址: http://course-platform-backend.xxx.cn-hangzhou.sae.aliyun.com
```

### 4.5 前端部署

#### 4.5.1 构建前端

```bash
cd frontend

# 安装依赖
npm install

# 构建生产版本
npm run build

# 输出目录: dist/
```

#### 4.5.2 部署到 OSS + CDN

```bash
# 安装 ossutil
# 配置 ossutil

# 上传到 OSS
ossutil cp -r dist/ oss://course-platform-files/web/ --update

# 设置静态网站托管
# 在 OSS 控制台 > 文件管理 > 静态页面
# 默认首页: index.html
# 默认404页: index.html

# 配置 CDN 加速
# 在 CDN 控制台添加域名加速
# 源站设置: OSS 域名
```

#### 4.5.3 部署到 SAE (可选)

```dockerfile
# frontend/Dockerfile
FROM nginx:alpine

COPY dist/ /usr/share/nginx/html/
COPY nginx.conf /etc/nginx/nginx.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
```

```bash
# 构建并推送镜像
docker build -t course-platform-frontend:latest .
docker tag course-platform-frontend:latest registry.cn-hangzhou.aliyuncs.com/your-namespace/course-platform-frontend:latest
docker push registry.cn-hangzhou.aliyuncs.com/your-namespace/course-platform-frontend:latest

# 在 SAE 创建前端应用
# 镜像地址: registry.cn-hangzhou.aliyuncs.com/your-namespace/course-platform-frontend:latest
```

---

## 五、域名与SSL配置

### 5.1 域名解析

```bash
# 登录阿里云 DNS 控制台
# 添加解析记录:

@       A   xxx.xxx.xxx.xxx (SLB公网IP)
www     A   xxx.xxx.xxx.xxx (SLB公网IP)
api     A   xxx.xxx.xxx.xxx (后端SAE地址)
```

### 5.2 SSL证书申请

```bash
# 在阿里云 SSL证书服务
# 1. 申请免费证书 (DV单域名证书)
# 2. 填写域名信息
# 3. 选择DNS验证
# 4. 添加DNS解析记录
# 5. 等待签发
# 6. 下载证书 (Nginx格式)
```

### 5.3 配置HTTPS

```nginx
# nginx.conf
server {
    listen 443 ssl;
    server_name www.yourdomain.com;

    ssl_certificate /etc/nginx/ssl/xxx.pem;
    ssl_certificate_key /etc/nginx/ssl/xxx.key;

    ssl_session_timeout 5m;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;
    ssl_protocols TLSv1.2 TLSv1.3;

    location / {
        root /usr/share/nginx/html;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    location /api {
        proxy_pass http://course-platform-backend.xxx.sae.aliyun.com;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}

server {
    listen 80;
    server_name www.yourdomain.com;
    return 301 https://$server_name$request_uri;
}
```

---

## 六、CI/CD 自动化部署

### 6.1 GitHub Actions 配置

```yaml
# .github/workflows/deploy.yml
name: Deploy to SAE

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          cd backend
          npm ci

      - name: Run tests
        run: |
          cd backend
          npm test

      - name: Build Docker image
        run: |
          docker build -t course-platform-backend:${{ github.sha }} backend/

      - name: Login to Aliyun Registry
        run: |
          echo "${{ secrets.ALIYUN_REGISTRY_PASSWORD }}" | docker login --username=${{ secrets.ALIYUN_REGISTRY_USERNAME }} --password-stdin registry.cn-hangzhou.aliyuncs.com

      - name: Push to Aliyun Registry
        run: |
          docker tag course-platform-backend:${{ github.sha }} registry.cn-hangzhou.aliyuncs.com/your-namespace/course-platform-backend:latest
          docker push registry.cn-hangzhou.aliyuncs.com/your-namespace/course-platform-backend:latest

      - name: Deploy to SAE
        run: |
          # 使用阿里云CLI触发SAE部署
          aliyun sae UpdateApplication \
            --AppId your-app-id \
            --ImageUrl registry.cn-hangzhou.aliyuncs.com/your-namespace/course-platform-backend:latest
```

### 6.2 Secrets 配置

在 GitHub 仓库设置中添加以下 Secrets：

```yaml
ALIYUN_REGISTRY_USERNAME: your_username
ALIYUN_REGISTRY_PASSWORD: your_password
ALIYUN_ACCESS_KEY_ID: your_access_key_id
ALIYUN_ACCESS_KEY_SECRET: your_access_key_secret
SAE_APP_ID: your_sae_app_id
```

---

## 七、监控与日志

### 7.1 SAE 监控

```bash
# 在 SAE 控制台 > 监控管理
# 查看:
  - CPU使用率
  - 内存使用率
  - 网络流量
  - 请求响应时间
  - 错误率
```

### 7.2 日志查询

```bash
# 在 SAE 控制台 > 日志管理
# 使用 SLS (日志服务) 查询日志

# 查询示例:
  - 查看错误日志: level:ERROR
  - 查看API慢查询: response_time > 1000
  - 查看特定用户: user_id:12345
```

### 7.3 告警配置

```bash
# 在 SAE 控制台 > 监控管理 > 告警
# 创建告警规则:

规则1: CPU使用率告警
  指标: cpu_util
  阈值: > 80%
  持续时间: 5分钟
  通知方式: 短信、邮件

规则2: 应用异常告警
  指标: instance_restart_count
  阈值: > 0
  通知方式: 短信、邮件

规则3: 错误率告警
  指标: http_server_error_code
  阈值: > 5%
  持续时间: 3分钟
  通知方式: 短信、邮件
```

---

## 八、备份与恢复

### 8.1 数据库备份

```bash
# PolarDB 自动备份
# 在 PolarDB 控制台 > 备份恢复
# 配置:
  - 备份周期: 每天
  - 备份时间: 02:00 - 04:00
  - 备份保留: 7天

# 手动备份
mysqldump -h rm-xxxxx.mysql.rds.aliyuncs.com -u course_user -p course_sharing_platform > backup_$(date +%Y%m%d).sql
```

### 8.2 数据恢复

```bash
# 从备份恢复
mysql -h rm-xxxxx.mysql.rds.aliyuncs.com -u course_user -p course_sharing_platform < backup_20251226.sql

# 或使用 PolarDB 控制台 > 备份恢复 > 恢复到新实例
```

---

## 九、常见问题排查

### 9.1 应用无法启动

```bash
# 检查日志:
  1. 在 SAE 控制台查看应用日志
  2. 查看实例事件
  3. 检查环境变量配置

# 常见原因:
  - 环境变量缺失或错误
  - 数据库连接失败
  - 端口配置错误
  - 内存不足
```

### 9.2 数据库连接失败

```bash
# 检查:
  1. 数据库白名单配置
  2. 数据库用户权限
  3. 连接地址和端口
  4. 密码是否正确

# 解决:
  - 在 PolarDB 控制台添加 SAE IP 到白名单
  - 确认数据库用户有访问权限
```

### 9.3 OSS 上传失败

```bash
# 检查:
  1. OSS AccessKey 是否正确
  2. Bucket 权限设置
  3. 文件大小是否超限
  4. 网络连接

# 解决:
  - 检查 OSS 环境变量配置
  - 确认 Bucket 名称正确
  - 调整文件大小限制
```

---

## 十、性能优化建议

### 10.1 应用层优化

```yaml
代码优化:
  - 使用连接池
  - 避免N+1查询
  - 使用缓存 (Redis)
  - 异步处理耗时任务

配置优化:
  - 增加实例数量
  - 启用 Gzip 压缩
  - 配置 CDN 加速
```

### 10.2 数据库优化

```yaml
索引优化:
  - 为常用查询字段添加索引
  - 避免过多索引影响写入性能

查询优化:
  - 使用 EXPLAIN 分析慢查询
  - 避免 SELECT *
  - 合理使用 LIMIT

架构优化:
  - 使用 PolarDB 读写分离
  - 热点数据缓存到 Redis
```

### 10.3 OSS 优化

```yaml
成本优化:
  - 使用生命周期管理
  - 冷数据转低频存储
  - 购买存储包和流量包

性能优化:
  - 启用 CDN 加速
  - 使用多线程上传
  - 前端直传 OSS
```

---

## 十一、安全加固

### 11.1 应用安全

```yaml
代码安全:
  - 输入验证与过滤
  - SQL注入防护 (使用参数化查询)
  - XSS防护 (输出转义)
  - CSRF防护 (Token验证)

网络安全:
  - 强制 HTTPS
  - 配置 CORS
  - 请求频率限制
  - IP白名单
```

### 11.2 数据安全

```yaml
数据库:
  - 开启 SSL 连接
  - 定期备份数据
  - 敏感字段加密存储

OSS:
  - 使用私有 Bucket
  - 临时签名URL
  - 防盗链配置
```

---

## 十二、运维手册

### 12.1 日常运维

```yaml
每日检查:
  - 应用运行状态
  - 错误日志查看
  - 监控指标检查

每周检查:
  - 数据库性能
  - 备份完整性
  - 安全告警

每月检查:
  - 成本分析
  - 容量规划
  - 性能优化
```

### 12.2 应急响应

```yaml
应用宕机:
  1. 查看错误日志
  2. 检查资源使用率
  3. 重启应用实例
  4. 回滚到上一版本

数据库故障:
  1. 切换到只读实例
  2. 恢复数据库备份
  3. 修复主实例
```

---

## 十三、项目交付清单

### 13.1 文档清单

- [x] 架构设计文档
- [x] 数据库设计文档
- [x] API设计文档
- [x] 前端设计文档
- [x] 云资源集成方案
- [x] 部署指南

### 13.2 代码清单

```
backend/
├── src/
│   ├── controllers/     # 控制器
│   ├── services/        # 业务逻辑
│   ├── models/          # 数据模型
│   ├── routes/          # 路由
│   ├── middlewares/     # 中间件
│   ├── utils/           # 工具函数
│   └── app.js           # 应用入口
├── tests/               # 测试文件
├── Dockerfile
└── package.json

frontend/
├── src/
│   ├── components/      # 组件
│   ├── pages/           # 页面
│   ├── services/        # API服务
│   ├── hooks/           # 自定义Hooks
│   ├── store/           # 状态管理
│   └── App.tsx
├── Dockerfile
└── package.json
```

### 13.3 部署清单

- [ ] PolarDB 实例创建并初始化
- [ ] OSS Bucket 创建并配置
- [ ] SAE 应用创建并部署
- [ ] 域名解析配置
- [ ] SSL证书配置
- [ ] 监控告警配置

---

*文档版本: v1.0*
*创建日期: 2025-12-26*
*最后更新: 2025-12-26*
