# 课程资料分享平台 - 部署指南

## 一、部署概述

### 1.1 部署架构

```
┌─────────────────────────────────────┐
│   阿里云轻量应用服务器 (2核2G)       │
│                                     │
│  ┌──────────────────────────────┐  │
│  │  Nginx (反向代理) : 80/443   │  │
│  └──────────────────────────────┘  │
│           ↓           ↓             │
│  ┌────────────┐  ┌─────────────┐   │
│  │  Frontend  │  │   Backend   │   │
│  │  : 3000    │  │   : 8080    │   │
│  └────────────┘  └─────────────┘   │
│                       ↓              │
│              ┌─────────────┐        │
│              │  Docker容器  │        │
│              └─────────────┘        │
└─────────────────────────────────────┘
         ↓                    ↓
    阿里云RDS MySQL      阿里云OSS
```

### 1.2 环境说明

| 环境 | 用途 | 域名/IP | 规格 |
|------|------|---------|------|
| 开发环境 | 本地开发 | localhost | Docker Compose |
| 生产环境 | 线上服务 | 服务器IP | 轻量应用服务器 2核2G |

---

## 二、本地开发环境搭建

### 2.1 前置要求

- **开发机**: Windows 10/11, macOS, 或 Linux
- **Node.js**: 18.17+ (LTS)
- **Docker Desktop**: 最新版
- **Git**: 最新版
- **VS Code**: 推荐IDE

### 2.2 克隆项目

```bash
# 克隆仓库
git clone https://github.com/aikunkun9527/Course-materials-sharing-platform.git
cd Course-materials-sharing-platform

# 安装后端依赖
cd backend
npm install

# 安装前端依赖
cd ../frontend
npm install
```

### 2.3 配置环境变量

```bash
# backend/.env.development
NODE_ENV=development
PORT=8080
DB_HOST=localhost
DB_PORT=3306
DB_NAME=course_sharing_platform
DB_USER=root
DB_PASSWORD=root
JWT_SECRET=dev_secret_key_change_in_production
JWT_EXPIRES_IN=7d
OSS_REGION=oss-cn-shenzhen
OSS_ACCESS_KEY_ID=your_access_key
OSS_ACCESS_KEY_SECRET=your_secret_key
OSS_BUCKET_NAME=your-bucket
CORS_ORIGIN=http://localhost:5173
```

### 2.4 启动开发环境

```bash
# 启动后端服务
cd backend
npm run dev

# 启动前端服务
cd frontend
npm run dev
```

### 2.5 访问应用

- 前端地址: http://localhost:5173
- 后端API: http://localhost:8080/api/v1

---

## 三、阿里云资源准备

### 3.1 开通服务

登录阿里云控制台，依次开通以下服务：

1. **轻量应用服务器**
   - 链接: https://swasnext.console.aliyun.com/servers/cn-shenzhen
   - 选择: 创建实例
   - 镜像: Ubuntu 22.04/20.04
   - 套餐: 2核2GB

2. **云数据库 RDS MySQL**
   - 链接: https://rds.console.aliyun.com/
   - 选择: 创建实例
   - 系列: 基础版或高可用版

3. **对象存储 OSS**
   - 链接: https://oss.console.aliyun.com/
   - 选择: 创建Bucket

### 3.2 创建 RAM 用户(可选)

```yaml
步骤:
  1. 访问 RAM控制台
  2. 创建用户: course-platform-app
  3. 访问方式: 编程访问
  4. 权限: AliyunRDSFullAccess, AliyunOSSFullAccess
  5. 保存 AccessKeyID 和 AccessKeySecret
```

### 3.3 资源配置建议

| 资源 | 配置 | 数量 | 预估成本/月 |
|------|------|------|------------|
| 轻量应用服务器 | 2核2GB Ubuntu | 1台 | ¥60-100 |
| RDS MySQL | 2核4GB | 1实例 | ¥30-50 |
| OSS | 500GB | - | 基本免费 |
| **合计** | | | **¥90-150** |

---

## 四、生产环境部署

### 4.1 连接服务器

```bash
# 方法1: 使用SSH密钥
ssh -i 你的密钥.pem root@你的服务器公网IP

# 方法2: 使用密码
ssh root@你的服务器公网IP

# 方法3: 使用阿里云控制台
# 在实例页面点击"远程连接" → ""
```

### 4.2 安装Docker和Nginx

```bash
# 更新系统
apt update && apt upgrade -y

# 安装Docker
curl -fsSL https://get.docker.com | sh
systemctl start docker
systemctl enable docker

# 安装Docker Compose
curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose

# 安装Nginx
apt install -y nginx
systemctl start nginx
systemctl enable nginx
```

### 4.3 配置RDS数据库

#### 4.3.1 创建数据库

```bash
# 在阿里云RDS控制台
# 1. 创建数据库实例
# 2. 获取数据库连接信息:
#    - 公网地址: rm-xxxxx.mysql.rds.aliyuncs.com
#    - 端口: 3306
#    - 初始账号: root
```

#### 4.3.2 初始化数据库

```bash
# 连接到数据库
mysql -h rm-xxxxx.mysql.rds.aliyuncs.com -P 3306 -u root -p

# 执行初始化脚本
CREATE DATABASE course_sharing_platform CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 导入表结构(参考 docs/02-数据库设计.md)
```

#### 4.3.3 配置白名单

```bash
# 在RDS控制台 > 数据安全性 > 白名单设置
# 添加轻量应用服务器的公网IP
# 例如: 47.112.161.3/32
```

### 4.4 配置OSS存储

#### 4.4.1 创建Bucket

```bash
# 登录OSS控制台
# 创建Bucket:
  - Bucket名称: course-platform-files (全局唯一)
  - 地域: 华南1(深圳)
  - 存储类型: 标准存储
  - 读写权限: 公共读(推荐)或私有
```

#### 4.4.2 配置Bucket

```bash
# 1. 设置生命周期规则(可选)
# 2. 配置跨域规则(CORS)
# 3. 设置防盗链(可选)
```

### 4.5 部署应用

#### 4.5.1 克隆项目

```bash
# 创建项目目录
mkdir -p /opt/course-platform
cd /opt

# 克隆项目
git clone https://github.com/aikunkun9527/Course-materials-sharing-platform.git course-platform
cd course-platform
```

#### 4.5.2 配置环境变量

```bash
# 复制环境变量模板
cp .env.production.template .env.production

# 编辑配置
vim .env.production
```

填写以下关键配置:
```bash
# 数据库配置
DB_HOST=你的RDS公网地址.mysql.rds.aliyuncs.com
DB_PORT=3306
DB_USER=你的数据库用户名
DB_PASSWORD=你的数据库密码
DB_NAME=course_sharing_platform

# OSS配置
OSS_REGION=oss-cn-shenzhen
OSS_ACCESS_KEY_ID=你的OSS_AccessKey_ID
OSS_ACCESS_KEY_SECRET=你的OSS_AccessKey_Secret
OSS_BUCKET_NAME=你的Bucket名称

# JWT密钥
JWT_SECRET=随机生成的32位以上字符串

# CORS配置
CORS_ORIGIN=http://你的服务器IP

# 应用配置
NODE_ENV=production
PORT=8080
```

#### 4.5.3 构建镜像

```bash
# 构建后端镜像
cd backend
docker build -t course-platform-backend:latest .

# 构建前端镜像
cd ../frontend

# 创建前端环境配置
cat > .env.production << EOF
VITE_API_BASE_URL=http://你的服务器IP/api/v1
VITE_APP_TITLE=课程资料分享平台
EOF

docker build -t course-platform-frontend:latest .

cd ..
```

#### 4.5.4 启动服务

```bash
# 复制docker-compose配置
cp docker-compose.server.yml docker-compose.yml

# 启动所有服务
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f
```

### 4.6 配置Nginx

```bash
# 复制Nginx配置
cp nginx-course-platform.conf /etc/nginx/sites-available/course-platform

# 编辑配置,修改域名或IP
vim /etc/nginx/sites-available/course-platform
# 修改 server_name 为你的服务器IP或域名

# 启用配置
ln -sf /etc/nginx/sites-available/course-platform /etc/nginx/sites-enabled/

# 测试配置
nginx -t

# 重启Nginx
systemctl restart nginx
```

### 4.7 配置防火墙

```bash
# 配置服务器防火墙
ufw allow 22/tcp
ufw allow 80/tcp
ufw allow 443/tcp
ufw --force enable

# 在阿里云控制台配置安全组
# 1. 进入轻量应用服务器控制台
# 2. 点击"防火墙"标签
# 3. 添加规则:
#    - 端口: 80, 协议: TCP, 来源: 0.0.0.0/0
#    - 端口: 443, 协议: TCP, 来源: 0.0.0.0/0
```

---

## 五、域名与SSL配置

### 5.1 域名解析

```bash
# 登录阿里云DNS控制台
# 添加解析记录:
@       A   你的服务器公网IP
www     A   你的服务器公网IP
```

### 5.2 SSL证书配置

```bash
# 安装Certbot
apt install -y certbot python3-certbot-nginx

# 获取证书
certbot --nginx -d your-domain.com

# 自动续期
certbot renew --dry-run
```

---

## 六、监控与维护

### 6.1 查看服务状态

```bash
cd /opt/course-platform

# 查看容器状态
docker-compose ps

# 查看日志
docker-compose logs -f backend
docker-compose logs -f frontend

# 查看资源使用
docker stats
```

### 6.2 更新应用

```bash
cd /opt/course-platform

# 拉取最新代码
git pull

# 重新构建镜像
docker-compose build

# 重启服务
docker-compose up -d
```

### 6.3 备份数据

```bash
# 数据库备份(RDS自动备份)
# 在RDS控制台设置自动备份策略

# 配置文件备份
tar -czf course-platform-config-$(date +%Y%m%d).tar.gz .env.production docker-compose.yml
```

---

## 七、常见问题排查

### 7.1 服务无法启动

```bash
# 查看详细日志
docker-compose logs backend

# 检查环境变量
cat .env.production

# 检查端口占用
netstat -tlnp | grep 8080
```

### 7.2 数据库连接失败

```bash
# 测试数据库连接
mysql -h 你的RDS地址 -u 用户名 -p

# 检查白名单
# 在RDS控制台确认服务器IP已添加
```

### 7.3 OSS上传失败

```bash
# 检查OSS配置
docker exec course-backend env | grep OSS

# 确认Bucket权限
# 确认AccessKey正确
```

---

## 八、自动化部署

使用一键部署脚本:

```bash
# 下载脚本
wget https://raw.githubusercontent.com/aikunkun9527/Course-materials-sharing-platform/main/deploy-server.sh

# 添加执行权限
chmod +x deploy-server.sh

# 运行脚本
./deploy-server.sh
```

详细文档请参考:
- [DEPLOY_LIGHTWEIGHT_SERVER.md](../DEPLOY_LIGHTWEIGHT_SERVER.md)
- [QUICK_START_SERVER.md](../QUICK_START_SERVER.md)

---

*文档版本: v2.0*
*创建日期: 2025-12-26*
*最后更新: 2026-01-10*
*更新内容: 全面迁移到轻量应用服务器部署方案*
