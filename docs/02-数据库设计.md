# 基于云计算的课程资料分享平台 - 数据库设计文档

## 一、数据库概述

### 1.1 数据库选型
- **数据库**: 阿里云 PolarDB for MySQL
- **版本**: MySQL 8.0+
- **字符集**: utf8mb4
- **排序规则**: utf8mb4_unicode_ci

### 1.2 命名规范
- 表名: 小写，下划线分隔，复数形式 (如: `users`, `courses`)
- 字段名: 小写，下划线分隔 (如: `user_id`, `created_at`)
- 主键: `id` (BIGINT UNSIGNED AUTO_INCREMENT)
- 时间戳: `created_at`, `updated_at` (DATETIME)
- 软删除: `deleted_at` (DATETIME NULLABLE)

---

## 二、数据库表设计 (ER图)

```
┌─────────────────┐       ┌─────────────────┐       ┌─────────────────┐
│     users       │       │     courses     │       │   enrollments   │
│─────────────────│       │─────────────────│       │─────────────────│
│ id (PK)         │──┐    │ id (PK)         │──┐    │ id (PK)         │
│ email           │  │    │ title           │  │    │ user_id (FK)    │
│ password        │  │    │ description     │  │    │ course_id (FK)  │
│ username        │  │    │ creator_id (FK) │  │    │ role            │
│ avatar_url      │  │    │ category        │  │    │ enrolled_at     │
│ role            │  │    │ cover_url       │  │    └─────────────────┘
│ created_at      │  │    │ created_at      │  │            │
│ updated_at      │  │    │ updated_at      │  │            │
└─────────────────┘  │    └─────────────────┘  │            │
                     │                          │            │
                     │         ┌────────────────┴────────────┘
                     │         │
                     ▼         ▼
              ┌──────────────────────────┐
              │       materials          │
              │──────────────────────────│
              │ id (PK)                  │
              │ course_id (FK)           │
              │ uploader_id (FK)         │
              │ title                    │
              │ description              │
              │ file_url (OSS)           │
              │ file_name                │
              │ file_size                │
              │ file_type                │
              │ download_count           │
              │ created_at               │
              └──────────────────────────┘
                      │
                      ▼
              ┌──────────────────────────┐       ┌─────────────────┐
              │      discussions         │       │      comments   │
              │──────────────────────────│       │─────────────────│
              │ id (PK)                  │       │ id (PK)         │
              │ course_id (FK)           │───────│ discussion_id   │
              │ author_id (FK)           │       │ author_id (FK)  │
              │ title                    │       │ content         │
              │ content                  │       │ parent_id (FK)  │
              │ view_count               │       │ created_at      │
              │ like_count               │       └─────────────────┘
              │ created_at               │
              └──────────────────────────┘
```

---

## 三、表结构详细设计

### 3.1 用户表 (users)

存储用户基本信息和认证数据。

| 字段名 | 类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|------|------|---------|--------|------|
| id | BIGINT | - | NO | AUTO_INCREMENT | 用户ID（主键） |
| email | VARCHAR | 100 | NO | - | 邮箱（唯一） |
| password | VARCHAR | 255 | NO | - | 密码（bcrypt加密） |
| username | VARCHAR | 50 | NO | - | 用户名 |
| avatar_url | VARCHAR | 500 | YES | NULL | 头像OSS地址 |
| role | ENUM | - | NO | 'student' | 角色：student/admin |
| bio | TEXT | - | YES | NULL | 个人简介 |
| status | TINYINT | 1 | NO | 1 | 状态：1=正常，0=禁用 |
| email_verified | BOOLEAN | - | NO | FALSE | 邮箱是否验证 |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | - | NO | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |
| deleted_at | DATETIME | - | YES | NULL | 软删除时间 |

**索引设计**:
```sql
PRIMARY KEY (id)
UNIQUE KEY idx_email (email)
INDEX idx_role (role)
INDEX idx_status (status)
INDEX idx_created_at (created_at)
```

**SQL建表语句**:
```sql
CREATE TABLE users (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    email VARCHAR(100) NOT NULL UNIQUE COMMENT '邮箱',
    password VARCHAR(255) NOT NULL COMMENT '密码（bcrypt加密）',
    username VARCHAR(50) NOT NULL COMMENT '用户名',
    avatar_url VARCHAR(500) DEFAULT NULL COMMENT '头像OSS地址',
    role ENUM('student', 'admin') NOT NULL DEFAULT 'student' COMMENT '角色',
    bio TEXT DEFAULT NULL COMMENT '个人简介',
    status TINYINT(1) NOT NULL DEFAULT 1 COMMENT '状态：1=正常，0=禁用',
    email_verified BOOLEAN NOT NULL DEFAULT FALSE COMMENT '邮箱是否验证',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    deleted_at DATETIME DEFAULT NULL COMMENT '软删除时间',
    INDEX idx_email (email),
    INDEX idx_role (role),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户表';
```

---

### 3.2 课程表 (courses)

存储课程基本信息。

| 字段名 | 类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|------|------|---------|--------|------|
| id | BIGINT | - | NO | AUTO_INCREMENT | 课程ID（主键） |
| title | VARCHAR | 200 | NO | - | 课程标题 |
| description | TEXT | - | YES | NULL | 课程描述 |
| creator_id | BIGINT | - | NO | - | 创建者ID（外键） |
| category | VARCHAR | 50 | YES | NULL | 课程分类 |
| cover_url | VARCHAR | 500 | YES | NULL | 封面图OSS地址 |
| max_students | INT | - | YES | NULL | 最大学生数 |
| current_students | INT | - | NO | 0 | 当前学生数 |
| status | ENUM | - | NO | 'active' | 状态：active/archived |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | - | NO | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |
| deleted_at | DATETIME | - | YES | NULL | 软删除时间 |

**索引设计**:
```sql
PRIMARY KEY (id)
INDEX idx_creator_id (creator_id)
INDEX idx_category (category)
INDEX idx_status (status)
FOREIGN KEY (creator_id) REFERENCES users(id)
```

**SQL建表语句**:
```sql
CREATE TABLE courses (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    title VARCHAR(200) NOT NULL COMMENT '课程标题',
    description TEXT DEFAULT NULL COMMENT '课程描述',
    creator_id BIGINT UNSIGNED NOT NULL COMMENT '创建者ID',
    category VARCHAR(50) DEFAULT NULL COMMENT '课程分类',
    cover_url VARCHAR(500) DEFAULT NULL COMMENT '封面图OSS地址',
    max_students INT DEFAULT NULL COMMENT '最大学生数',
    current_students INT NOT NULL DEFAULT 0 COMMENT '当前学生数',
    status ENUM('active', 'archived') NOT NULL DEFAULT 'active' COMMENT '状态',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    deleted_at DATETIME DEFAULT NULL COMMENT '软删除时间',
    INDEX idx_creator_id (creator_id),
    INDEX idx_category (category),
    INDEX idx_status (status),
    FOREIGN KEY (creator_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='课程表';
```

---

### 3.3 课程成员表 (enrollments)

存储学生选课信息。

| 字段名 | 类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|------|------|---------|--------|------|
| id | BIGINT | - | NO | AUTO_INCREMENT | 记录ID（主键） |
| user_id | BIGINT | - | NO | - | 用户ID（外键） |
| course_id | BIGINT | - | NO | - | 课程ID（外键） |
| role | ENUM | - | NO | 'student' | 角色：student/assistant |
| enrolled_at | DATETIME | - | NO | CURRENT_TIMESTAMP | 选课时间 |

**索引设计**:
```sql
PRIMARY KEY (id)
UNIQUE KEY idx_user_course (user_id, course_id)
INDEX idx_course_id (course_id)
FOREIGN KEY (user_id) REFERENCES users(id)
FOREIGN KEY (course_id) REFERENCES courses(id)
```

**SQL建表语句**:
```sql
CREATE TABLE enrollments (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
    course_id BIGINT UNSIGNED NOT NULL COMMENT '课程ID',
    role ENUM('student', 'assistant') NOT NULL DEFAULT 'student' COMMENT '角色',
    enrolled_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '选课时间',
    UNIQUE KEY idx_user_course (user_id, course_id),
    INDEX idx_course_id (course_id),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (course_id) REFERENCES courses(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='课程成员表';
```

---

### 3.4 资料表 (materials)

存储课程资料元数据。

| 字段名 | 类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|------|------|---------|--------|------|
| id | BIGINT | - | NO | AUTO_INCREMENT | 资料ID（主键） |
| course_id | BIGINT | - | NO | - | 课程ID（外键） |
| uploader_id | BIGINT | - | NO | - | 上传者ID（外键） |
| title | VARCHAR | 200 | NO | - | 资料标题 |
| description | TEXT | - | YES | NULL | 资料描述 |
| file_url | VARCHAR | 500 | NO | - | 文件OSS地址 |
| file_name | VARCHAR | 255 | NO | - | 原始文件名 |
| file_size | BIGINT | - | NO | 0 | 文件大小（字节） |
| file_type | VARCHAR | 50 | NO | - | 文件类型（MIME） |
| file_extension | VARCHAR | 20 | NO | - | 文件扩展名 |
| download_count | INT | - | NO | 0 | 下载次数 |
| is_public | BOOLEAN | - | NO | TRUE | 是否公开 |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | - | NO | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |
| deleted_at | DATETIME | - | YES | NULL | 软删除时间 |

**索引设计**:
```sql
PRIMARY KEY (id)
INDEX idx_course_id (course_id)
INDEX idx_uploader_id (uploader_id)
INDEX idx_file_type (file_type)
INDEX idx_created_at (created_at)
FOREIGN KEY (course_id) REFERENCES courses(id)
FOREIGN KEY (uploader_id) REFERENCES users(id)
```

**SQL建表语句**:
```sql
CREATE TABLE materials (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    course_id BIGINT UNSIGNED NOT NULL COMMENT '课程ID',
    uploader_id BIGINT UNSIGNED NOT NULL COMMENT '上传者ID',
    title VARCHAR(200) NOT NULL COMMENT '资料标题',
    description TEXT DEFAULT NULL COMMENT '资料描述',
    file_url VARCHAR(500) NOT NULL COMMENT '文件OSS地址',
    file_name VARCHAR(255) NOT NULL COMMENT '原始文件名',
    file_size BIGINT NOT NULL DEFAULT 0 COMMENT '文件大小（字节）',
    file_type VARCHAR(50) NOT NULL COMMENT '文件类型（MIME）',
    file_extension VARCHAR(20) NOT NULL COMMENT '文件扩展名',
    download_count INT NOT NULL DEFAULT 0 COMMENT '下载次数',
    is_public BOOLEAN NOT NULL DEFAULT TRUE COMMENT '是否公开',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    deleted_at DATETIME DEFAULT NULL COMMENT '软删除时间',
    INDEX idx_course_id (course_id),
    INDEX idx_uploader_id (uploader_id),
    INDEX idx_file_type (file_type),
    INDEX idx_created_at (created_at),
    FOREIGN KEY (course_id) REFERENCES courses(id) ON DELETE CASCADE,
    FOREIGN KEY (uploader_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='资料表';
```

---

### 3.5 讨论表 (discussions)

存储课程讨论主题。

| 字段名 | 类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|------|------|---------|--------|------|
| id | BIGINT | - | NO | AUTO_INCREMENT | 讨论ID（主键） |
| course_id | BIGINT | - | NO | - | 课程ID（外键） |
| author_id | BIGINT | - | NO | - | 作者ID（外键） |
| title | VARCHAR | 200 | NO | - | 讨论标题 |
| content | TEXT | - | NO | - | 讨论内容 |
| view_count | INT | - | NO | 0 | 浏览次数 |
| like_count | INT | - | NO | 0 | 点赞数 |
| comment_count | INT | - | NO | 0 | 评论数 |
| is_pinned | BOOLEAN | - | NO | FALSE | 是否置顶 |
| is_locked | BOOLEAN | - | NO | FALSE | 是否锁定 |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | - | NO | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |
| deleted_at | DATETIME | - | YES | NULL | 软删除时间 |

**索引设计**:
```sql
PRIMARY KEY (id)
INDEX idx_course_id (course_id)
INDEX idx_author_id (author_id)
INDEX idx_created_at (created_at)
FOREIGN KEY (course_id) REFERENCES courses(id)
FOREIGN KEY (author_id) REFERENCES users(id)
```

**SQL建表语句**:
```sql
CREATE TABLE discussions (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    course_id BIGINT UNSIGNED NOT NULL COMMENT '课程ID',
    author_id BIGINT UNSIGNED NOT NULL COMMENT '作者ID',
    title VARCHAR(200) NOT NULL COMMENT '讨论标题',
    content TEXT NOT NULL COMMENT '讨论内容',
    view_count INT NOT NULL DEFAULT 0 COMMENT '浏览次数',
    like_count INT NOT NULL DEFAULT 0 COMMENT '点赞数',
    comment_count INT NOT NULL DEFAULT 0 COMMENT '评论数',
    is_pinned BOOLEAN NOT NULL DEFAULT FALSE COMMENT '是否置顶',
    is_locked BOOLEAN NOT NULL DEFAULT FALSE COMMENT '是否锁定',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    deleted_at DATETIME DEFAULT NULL COMMENT '软删除时间',
    INDEX idx_course_id (course_id),
    INDEX idx_author_id (author_id),
    INDEX idx_created_at (created_at),
    INDEX idx_is_pinned (is_pinned),
    FOREIGN KEY (course_id) REFERENCES courses(id) ON DELETE CASCADE,
    FOREIGN KEY (author_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='讨论表';
```

---

### 3.6 评论表 (comments)

存储讨论评论和回复。

| 字段名 | 类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|------|------|---------|--------|------|
| id | BIGINT | - | NO | AUTO_INCREMENT | 评论ID（主键） |
| discussion_id | BIGINT | - | NO | - | 讨论ID（外键） |
| author_id | BIGINT | - | NO | - | 作者ID（外键） |
| parent_id | BIGINT | - | YES | NULL | 父评论ID（自关联） |
| content | TEXT | - | NO | - | 评论内容 |
| like_count | INT | - | NO | 0 | 点赞数 |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | - | NO | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |
| deleted_at | DATETIME | - | YES | NULL | 软删除时间 |

**索引设计**:
```sql
PRIMARY KEY (id)
INDEX idx_discussion_id (discussion_id)
INDEX idx_author_id (author_id)
INDEX idx_parent_id (parent_id)
INDEX idx_created_at (created_at)
FOREIGN KEY (discussion_id) REFERENCES discussions(id)
FOREIGN KEY (author_id) REFERENCES users(id)
FOREIGN KEY (parent_id) REFERENCES comments(id)
```

**SQL建表语句**:
```sql
CREATE TABLE comments (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    discussion_id BIGINT UNSIGNED NOT NULL COMMENT '讨论ID',
    author_id BIGINT UNSIGNED NOT NULL COMMENT '作者ID',
    parent_id BIGINT UNSIGNED DEFAULT NULL COMMENT '父评论ID',
    content TEXT NOT NULL COMMENT '评论内容',
    like_count INT NOT NULL DEFAULT 0 COMMENT '点赞数',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    deleted_at DATETIME DEFAULT NULL COMMENT '软删除时间',
    INDEX idx_discussion_id (discussion_id),
    INDEX idx_author_id (author_id),
    INDEX idx_parent_id (parent_id),
    INDEX idx_created_at (created_at),
    FOREIGN KEY (discussion_id) REFERENCES discussions(id) ON DELETE CASCADE,
    FOREIGN KEY (author_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (parent_id) REFERENCES comments(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='评论表';
```

---

### 3.7 点赞记录表 (likes)

存储用户点赞记录（防止重复点赞）。

| 字段名 | 类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|------|------|---------|--------|------|
| id | BIGINT | - | NO | AUTO_INCREMENT | 记录ID（主键） |
| user_id | BIGINT | - | NO | - | 用户ID（外键） |
| target_type | ENUM | - | NO | - | 目标类型：discussion/comment |
| target_id | BIGINT | - | NO | - | 目标ID |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | 创建时间 |

**索引设计**:
```sql
PRIMARY KEY (id)
UNIQUE KEY idx_user_target (user_id, target_type, target_id)
INDEX idx_target (target_type, target_id)
FOREIGN KEY (user_id) REFERENCES users(id)
```

**SQL建表语句**:
```sql
CREATE TABLE likes (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
    target_type ENUM('discussion', 'comment') NOT NULL COMMENT '目标类型',
    target_id BIGINT UNSIGNED NOT NULL COMMENT '目标ID',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    UNIQUE KEY idx_user_target (user_id, target_type, target_id),
    INDEX idx_target (target_type, target_id),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='点赞记录表';
```

---

### 3.8 下载记录表 (download_logs)

记录文件下载日志。

| 字段名 | 类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|------|------|---------|--------|------|
| id | BIGINT | - | NO | AUTO_INCREMENT | 记录ID（主键） |
| material_id | BIGINT | - | NO | - | 资料ID（外键） |
| user_id | BIGINT | - | NO | - | 用户ID（外键） |
| ip_address | VARCHAR | 45 | YES | NULL | IP地址 |
| user_agent | VARCHAR | 500 | YES | NULL | 用户代理 |
| downloaded_at | DATETIME | - | NO | CURRENT_TIMESTAMP | 下载时间 |

**索引设计**:
```sql
PRIMARY KEY (id)
INDEX idx_material_id (material_id)
INDEX idx_user_id (user_id)
INDEX idx_downloaded_at (downloaded_at)
FOREIGN KEY (material_id) REFERENCES materials(id)
FOREIGN KEY (user_id) REFERENCES users(id)
```

**SQL建表语句**:
```sql
CREATE TABLE download_logs (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    material_id BIGINT UNSIGNED NOT NULL COMMENT '资料ID',
    user_id BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
    ip_address VARCHAR(45) DEFAULT NULL COMMENT 'IP地址',
    user_agent VARCHAR(500) DEFAULT NULL COMMENT '用户代理',
    downloaded_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '下载时间',
    INDEX idx_material_id (material_id),
    INDEX idx_user_id (user_id),
    INDEX idx_downloaded_at (downloaded_at),
    FOREIGN KEY (material_id) REFERENCES materials(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='下载记录表';
```

---

## 四、数据库初始化脚本

### 4.1 完整初始化SQL

```sql
-- ====================================
-- 基于云计算的课程资料分享平台
-- 数据库初始化脚本
-- ====================================

-- 创建数据库
CREATE DATABASE IF NOT EXISTS course_sharing_platform
    DEFAULT CHARACTER SET utf8mb4
    COLLATE utf8mb4_unicode_ci;

USE course_sharing_platform;

-- 设置时区
SET time_zone = '+08:00';

-- ====================================
-- 1. 用户表
-- ====================================
CREATE TABLE users (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    email VARCHAR(100) NOT NULL UNIQUE COMMENT '邮箱',
    password VARCHAR(255) NOT NULL COMMENT '密码（bcrypt加密）',
    username VARCHAR(50) NOT NULL COMMENT '用户名',
    avatar_url VARCHAR(500) DEFAULT NULL COMMENT '头像OSS地址',
    role ENUM('student', 'admin') NOT NULL DEFAULT 'student' COMMENT '角色',
    bio TEXT DEFAULT NULL COMMENT '个人简介',
    status TINYINT(1) NOT NULL DEFAULT 1 COMMENT '状态：1=正常，0=禁用',
    email_verified BOOLEAN NOT NULL DEFAULT FALSE COMMENT '邮箱是否验证',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    deleted_at DATETIME DEFAULT NULL COMMENT '软删除时间',
    INDEX idx_email (email),
    INDEX idx_role (role),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户表';

-- ====================================
-- 2. 课程表
-- ====================================
CREATE TABLE courses (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    title VARCHAR(200) NOT NULL COMMENT '课程标题',
    description TEXT DEFAULT NULL COMMENT '课程描述',
    creator_id BIGINT UNSIGNED NOT NULL COMMENT '创建者ID',
    category VARCHAR(50) DEFAULT NULL COMMENT '课程分类',
    cover_url VARCHAR(500) DEFAULT NULL COMMENT '封面图OSS地址',
    max_students INT DEFAULT NULL COMMENT '最大学生数',
    current_students INT NOT NULL DEFAULT 0 COMMENT '当前学生数',
    status ENUM('active', 'archived') NOT NULL DEFAULT 'active' COMMENT '状态',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    deleted_at DATETIME DEFAULT NULL COMMENT '软删除时间',
    INDEX idx_creator_id (creator_id),
    INDEX idx_category (category),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at),
    FOREIGN KEY (creator_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='课程表';

-- ====================================
-- 3. 课程成员表
-- ====================================
CREATE TABLE enrollments (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
    course_id BIGINT UNSIGNED NOT NULL COMMENT '课程ID',
    role ENUM('student', 'assistant') NOT NULL DEFAULT 'student' COMMENT '角色',
    enrolled_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '选课时间',
    UNIQUE KEY idx_user_course (user_id, course_id),
    INDEX idx_course_id (course_id),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (course_id) REFERENCES courses(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='课程成员表';

-- ====================================
-- 4. 资料表
-- ====================================
CREATE TABLE materials (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    course_id BIGINT UNSIGNED NOT NULL COMMENT '课程ID',
    uploader_id BIGINT UNSIGNED NOT NULL COMMENT '上传者ID',
    title VARCHAR(200) NOT NULL COMMENT '资料标题',
    description TEXT DEFAULT NULL COMMENT '资料描述',
    file_url VARCHAR(500) NOT NULL COMMENT '文件OSS地址',
    file_name VARCHAR(255) NOT NULL COMMENT '原始文件名',
    file_size BIGINT NOT NULL DEFAULT 0 COMMENT '文件大小（字节）',
    file_type VARCHAR(50) NOT NULL COMMENT '文件类型（MIME）',
    file_extension VARCHAR(20) NOT NULL COMMENT '文件扩展名',
    download_count INT NOT NULL DEFAULT 0 COMMENT '下载次数',
    is_public BOOLEAN NOT NULL DEFAULT TRUE COMMENT '是否公开',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    deleted_at DATETIME DEFAULT NULL COMMENT '软删除时间',
    INDEX idx_course_id (course_id),
    INDEX idx_uploader_id (uploader_id),
    INDEX idx_file_type (file_type),
    INDEX idx_created_at (created_at),
    FOREIGN KEY (course_id) REFERENCES courses(id) ON DELETE CASCADE,
    FOREIGN KEY (uploader_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='资料表';

-- ====================================
-- 5. 讨论表
-- ====================================
CREATE TABLE discussions (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    course_id BIGINT UNSIGNED NOT NULL COMMENT '课程ID',
    author_id BIGINT UNSIGNED NOT NULL COMMENT '作者ID',
    title VARCHAR(200) NOT NULL COMMENT '讨论标题',
    content TEXT NOT NULL COMMENT '讨论内容',
    view_count INT NOT NULL DEFAULT 0 COMMENT '浏览次数',
    like_count INT NOT NULL DEFAULT 0 COMMENT '点赞数',
    comment_count INT NOT NULL DEFAULT 0 COMMENT '评论数',
    is_pinned BOOLEAN NOT NULL DEFAULT FALSE COMMENT '是否置顶',
    is_locked BOOLEAN NOT NULL DEFAULT FALSE COMMENT '是否锁定',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    deleted_at DATETIME DEFAULT NULL COMMENT '软删除时间',
    INDEX idx_course_id (course_id),
    INDEX idx_author_id (author_id),
    INDEX idx_created_at (created_at),
    INDEX idx_is_pinned (is_pinned),
    FOREIGN KEY (course_id) REFERENCES courses(id) ON DELETE CASCADE,
    FOREIGN KEY (author_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='讨论表';

-- ====================================
-- 6. 评论表
-- ====================================
CREATE TABLE comments (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    discussion_id BIGINT UNSIGNED NOT NULL COMMENT '讨论ID',
    author_id BIGINT UNSIGNED NOT NULL COMMENT '作者ID',
    parent_id BIGINT UNSIGNED DEFAULT NULL COMMENT '父评论ID',
    content TEXT NOT NULL COMMENT '评论内容',
    like_count INT NOT NULL DEFAULT 0 COMMENT '点赞数',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    deleted_at DATETIME DEFAULT NULL COMMENT '软删除时间',
    INDEX idx_discussion_id (discussion_id),
    INDEX idx_author_id (author_id),
    INDEX idx_parent_id (parent_id),
    INDEX idx_created_at (created_at),
    FOREIGN KEY (discussion_id) REFERENCES discussions(id) ON DELETE CASCADE,
    FOREIGN KEY (author_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (parent_id) REFERENCES comments(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='评论表';

-- ====================================
-- 7. 点赞记录表
-- ====================================
CREATE TABLE likes (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
    target_type ENUM('discussion', 'comment') NOT NULL COMMENT '目标类型',
    target_id BIGINT UNSIGNED NOT NULL COMMENT '目标ID',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    UNIQUE KEY idx_user_target (user_id, target_type, target_id),
    INDEX idx_target (target_type, target_id),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='点赞记录表';

-- ====================================
-- 8. 下载记录表
-- ====================================
CREATE TABLE download_logs (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    material_id BIGINT UNSIGNED NOT NULL COMMENT '资料ID',
    user_id BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
    ip_address VARCHAR(45) DEFAULT NULL COMMENT 'IP地址',
    user_agent VARCHAR(500) DEFAULT NULL COMMENT '用户代理',
    downloaded_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '下载时间',
    INDEX idx_material_id (material_id),
    INDEX idx_user_id (user_id),
    INDEX idx_downloaded_at (downloaded_at),
    FOREIGN KEY (material_id) REFERENCES materials(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='下载记录表';

-- ====================================
-- 插入初始管理员账号
-- 密码: admin123 (需要在应用中bcrypt加密后插入)
-- ====================================
-- INSERT INTO users (email, password, username, role, email_verified)
-- VALUES ('admin@course.com', '$2b$10$...', '系统管理员', 'admin', TRUE);

-- ====================================
-- 插入测试数据（可选）
-- ====================================

-- 完成
SELECT 'Database initialized successfully!' AS message;
```

---

## 五、数据库优化建议

### 5.1 索引优化
- 对常用查询字段建立索引
- 复合索引遵循最左前缀原则
- 定期分析慢查询日志

### 5.2 分区策略
当数据量增长时，考虑对以下表进行分区：
- `download_logs` - 按时间范围分区
- `comments` - 按讨论ID哈希分区

### 5.3 读写分离
- PolarDB支持读写分离
- 读操作：从只读实例
- 写操作：主实例

### 5.4 缓存策略
- 热点课程数据缓存到Redis
- 用户会话缓存
- 讨论区帖子列表缓存

---

## 六、数据字典

### 6.1 枚举类型说明

#### users.role
- `student`: 学生（默认）
- `admin`: 管理员

> **说明**: 项目已移除教师角色，所有用户（包括学生和管理员）都可以创建课程。

#### courses.status
- `active`: 进行中（默认）
- `archived`: 已归档

#### enrollments.role
- `student`: 学生（默认）
- `assistant`: 助教

#### discussions.target_type
- `discussion`: 讨论主题
- `comment`: 评论

### 6.2 文件类型限制

允许上传的文件类型：
- **文档**: PDF, DOC, DOCX, PPT, PPTX, TXT
- **图片**: JPG, JPEG, PNG, GIF
- **视频**: MP4, AVI, MOV
- **压缩包**: ZIP, RAR

文件大小限制：
- 单个文件最大 100MB
- 每个课程总资料最大 10GB

---

*文档版本: v1.0*
*创建日期: 2025-12-26*
