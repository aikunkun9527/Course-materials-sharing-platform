# 云资源集成方案

## 一、概述

本文档介绍如何在阿里云轻量应用服务器上集成课程资料分享平台所需的各项云服务。

## 二、云服务架构

```
┌─────────────────────────────────────┐
│   阿里云轻量应用服务器 (2核2G)       │
│                                     │
│  ┌──────────────────────────────┐  │
│  │  Docker 容器                │  │
│  │  ├─ Backend (Node.js)       │  │
│  │  └─ Frontend (React/Nginx)  │  │
│  └──────────────────────────────┘  │
└─────────────────────────────────────┘
         ↓                    ↓
    阿里云RDS MySQL      阿里云OSS
```

## 三、阿里云 RDS MySQL 集成

### 3.1 创建RDS实例

1. **登录控制台**
   - 访问: https://rds.console.aliyun.com/
   - 选择: 创建实例

2. **选择配置**
   ```
   数据库引擎: MySQL
   版本: 8.0
   系列: 基础版
   规格: 2核4GB (推荐)
   存储空间: 100GB
   网络: 专有网络 (VPC)
   ```

3. **设置白名单**
   - 在RDS控制台 > 数据安全性 > 白名单设置
   - 添加轻量应用服务器的公网IP
   - 例如: `47.112.161.3/32`

### 3.2 初始化数据库

```bash
# 连接到RDS
mysql -h rm-xxxxx.mysql.rds.aliyuncs.com -u root -p

# 创建数据库
CREATE DATABASE course_sharing_platform CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

# 创建用户(可选)
CREATE USER 'course_admin'@'%' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON course_sharing_platform.* TO 'course_admin'@'%';
FLUSH PRIVILEGES;
```

### 3.3 配置连接

在 `.env.production` 中配置:
```bash
DB_HOST=rm-xxxxx.mysql.rds.aliyuncs.com
DB_PORT=3306
DB_USER=course_admin
DB_PASSWORD=your_password
DB_NAME=course_sharing_platform
```

## 四、阿里云 OSS 集成

### 4.1 创建Bucket

1. **登录控制台**
   - 访问: https://oss.console.aliyun.com/
   - 选择: 创建Bucket

2. **配置Bucket**
   ```
   Bucket名称: course-platform-files (全局唯一)
   地域: 华南1(深圳)
   存储类型: 标准存储
   读写权限: 公共读 (推荐)
   ```

### 4.2 配置Bucket

1. **设置生命周期** (可选)
   - 规则1: 删除临时文件
     - 前缀: `temp/`
     - 过期时间: 7天

2. **配置CORS** (如果需要前端直传)
   ```json
   {
     "allowedOrigins": ["*"],
     "allowedMethods": ["GET", "POST", "PUT", "DELETE", "HEAD"],
     "allowedHeaders": ["*"],
     "exposeHeaders": ["ETag"],
     "maxAgeSeconds": 3600
   }
   ```

3. **设置防盗链** (可选)
   - 允许空Referer: 否
   - 白名单: 你的域名

### 4.3 获取AccessKey

1. **创建RAM用户** (可选,推荐)
   - 访问: https://ram.console.aliyun.com/
   - 创建用户: `course-platform-app`
   - 权限: `AliyunOSSFullAccess`

2. **创建AccessKey**
   - 在RAM用户详情页
   - 创建AccessKey
   - 保存 AccessKeyID 和 AccessKeySecret

### 4.4 配置OSS连接

在 `.env.production` 中配置:
```bash
OSS_REGION=oss-cn-shenzhen
OSS_ACCESS_KEY_ID=your_access_key_id
OSS_ACCESS_KEY_SECRET=your_access_key_secret
OSS_BUCKET_NAME=course-platform-files
```

## 五、轻量应用服务器配置

### 5.1 购买服务器

1. **登录控制台**
   - 访问: https://swasnext.console.aliyun.com/servers/cn-shenzhen
   - 选择: 创建实例

2. **选择配置**
   ```
   镜像: Ubuntu 22.04/20.04
   套餐: 2核2GB
   时长: 1个月/3个月/1年
   ```

3. **设置密码**
   - 选择: 自定义密码
   - 设置root密码

### 5.2 安全组配置

1. **添加防火墙规则**
   - 端口: 22, 协议: TCP, 来源: 0.0.0.0/0 (SSH)
   - 端口: 80, 协议: TCP, 来源: 0.0.0.0/0 (HTTP)
   - 端口: 443, 协议: TCP, 来源: 0.0.0.0/0 (HTTPS)

### 5.3 安装Docker

```bash
# 更新系统
apt update && apt upgrade -y

# 安装Docker
curl -fsSL https://get.docker.com | sh
systemctl start docker
systemctl enable docker

# 安装Docker Compose
curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose
```

## 六、环境变量配置

### 6.1 后端配置 (.env.production)

```bash
# 应用配置
NODE_ENV=production
PORT=8080

# 数据库配置
DB_HOST=your-rds-mysql.rds.aliyuncs.com
DB_PORT=3306
DB_USER=course_admin
DB_PASSWORD=your_password
DB_NAME=course_sharing_platform

# OSS配置
OSS_REGION=oss-cn-shenzhen
OSS_ACCESS_KEY_ID=your_access_key_id
OSS_ACCESS_KEY_SECRET=your_access_key_secret
OSS_BUCKET_NAME=course-platform-files

# JWT配置
JWT_SECRET=your_jwt_secret_min_32_characters
JWT_EXPIRES_IN=7d

# CORS配置
CORS_ORIGIN=http://your-server-ip

# 日志配置
LOG_LEVEL=info
```

### 6.2 前端配置 (.env.production)

```bash
VITE_API_BASE_URL=http://your-server-ip/api/v1
VITE_APP_TITLE=课程资料分享平台
```

## 七、验证集成

### 7.1 测试数据库连接

```bash
# 从服务器测试
mysql -h your-rds-host -u course_admin -p course_sharing_platform

# 应该能成功连接
```

### 7.2 测试OSS上传

```bash
# 在后端项目中测试
cd backend
npm test test-cloud-config.js

# 应该显示OSS连接成功
```

### 7.3 测试完整应用

```bash
# 启动服务
docker-compose up -d

# 查看日志
docker-compose logs -f

# 访问应用
curl http://localhost:8080/health
```

## 八、监控与成本

### 8.1 监控方案

- **轻量应用服务器**
  - CPU使用率
  - 内存使用率
  - 磁盘使用率
  - 网络流量

- **RDS MySQL**
  - 连接数
  - 慢查询日志
  - 存储空间

- **OSS**
  - 存储容量
  - 请求次数
  - 流量使用

### 8.2 成本估算

| 服务 | 配置 | 预估成本/月 |
|------|------|------------|
| 轻量应用服务器 | 2核2GB | ¥60-100 |
| RDS MySQL | 2核4GB | ¥30-50 |
| OSS | 500GB | 基本免费 |
| **合计** | | **¥90-150** |

## 九、故障排查

### 9.1 数据库连接失败

**问题**: 无法连接到RDS

**解决**:
1. 检查白名单配置
2. 确认用户名密码正确
3. 测试网络连通性

```bash
telnet rm-xxxxx.mysql.rds.aliyuncs.com 3306
```

### 9.2 OSS上传失败

**问题**: 文件无法上传到OSS

**解决**:
1. 检查AccessKey是否正确
2. 确认Bucket权限
3. 查看OSS服务状态

### 9.3 应用无法启动

**问题**: Docker容器启动失败

**解决**:
1. 查看容器日志
2. 检查环境变量
3. 验证镜像构建

```bash
docker-compose logs backend
```

## 十、最佳实践

1. **安全性**
   - 使用强密码
   - 定期更新AccessKey
   - 配置白名单
   - 启用HTTPS

2. **性能优化**
   - 配置Swap(2GB)
   - 启用Nginx缓存
   - 使用OSS CDN
   - 优化数据库查询

3. **备份策略**
   - RDS自动备份
   - 定期导出配置文件
   - 版本控制代码

4. **监控告警**
   - 设置资源使用率告警
   - 配置日志监控
   - 定期检查服务状态

---

*文档版本: v2.0*
*创建日期: 2025-12-26*
*最后更新: 2026-01-10*
*更新内容: 全面迁移到轻量应用服务器集成方案*
